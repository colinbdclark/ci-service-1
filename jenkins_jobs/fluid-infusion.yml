- job:
    name: 'fluid-infusion'
    project-type: 'multijob'
    concurrent: false
    display-name: 'Fluid Infusion'
    node: h-0005.tor1.incd.ca
    scm:
      - git:
          url: https://github.com/fluid-project/infusion.git
          branches:
            - master
    triggers:
      - github
    wrappers:
      - timeout:
          # Abort after these many minutes
          timeout: 25
          # Mark the build as failed
          fail: true
    builders:
      # Each parent multijob builder passes the Jenkins WORKSPACE environment
      # variable to its child job as a parameter so that a common Git working
      # directory can be used.
      - multijob:
          name: create-infusion-vm
          condition: COMPLETED
          projects:
            - name: create-infusion-vm
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: infusion-tests
          condition: COMPLETED
          projects:
            - name: infusion-tests
              predefined-parameters: parent_workspace=$WORKSPACE
      - multijob:
          name: delete-infusion-vm
          condition: SUCCESSFUL
          projects:
            - name: delete-infusion-vm
              predefined-parameters: parent_workspace=$WORKSPACE

- job:
    name: create-infusion-vm
    description: 'Job responsible for creating a test VM'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      # Setting BUILD_ID for the vagrant process to make sure the Jenkins process tree killer
      # doesn't kill the VM before the next job is started.
      #
      # Since the node_modules directory might not be synchronized between VM and host (GPII-2060)
      # it's necessary to run `npm install` on the host to get auxiliary tools installed (e.g grunt)
      - shell: BUILD_ID=infusion DISPLAY=:0 vagrant up --provider virtualbox && npm install

- job:
    name: infusion-tests
    description: 'Fluid Infusion tests'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant ssh -c 'cd /home/vagrant/sync; npm install'
      - shell: vagrant ssh -c 'cd /home/vagrant/sync; grunt clean stylus modulefiles:all pathMap:all copy:all copy:necessities uglify:all concat:all compress:all'
      - shell: npm run test:vagrant
    publishers:
      - tap:
          results: report.tap
      - email:
          recipients: builds@lists.idrc.ocad.ca
      - ssh:
          site: 'build.fluidproject.org'
          source: 'build/**'
          # The 'products' prefix gets removed on the remote server
          remove-prefix: 'build'
          target: '/var/www/4597d990/infusion'
          fail-on-error: true
          use-pty: true
          timeout: 180000

- job:
    name: delete-infusion-vm
    description: 'Job responsible for deleting the test VM'
    node: h-0005.tor1.incd.ca
    workspace: $parent_workspace
    builders:
      - shell: vagrant destroy -f
